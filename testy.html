<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini-gra: dopasuj elementy + obrÃ³t</title>
  <style>
    body{
      font-family: system-ui, sans-serif;
      background:#0b0b10;
      color:#eaeaf2;
      display:flex;
      justify-content:center;
      padding:24px;
      margin:0;
    }
    .wrap{ width:min(960px, 96vw); }
    .hud{ display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .btn{
      background:#22233a; color:#fff;
      border:1px solid #3a3b5b;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
    }
    .hint{ opacity:.82; font-size:14px; line-height:1.25; }

    .board{
      position:relative;
      width:100%;
      aspect-ratio: 1 / 1; /* dopasuj, jeÅ›li tÅ‚o ma inne proporcje */
      border-radius:18px;
      overflow:hidden;
      border:1px solid #2a2b44;
      background:#111;
      touch-action:none;
    }
    .board img.bg{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      user-select:none;
      pointer-events:none;
    }

    .piece{
      position:absolute;
      height:auto;
      cursor:grab;
      user-select:none;
      touch-action:none;
      transform-origin:center center;
      will-change: transform, filter, left, top;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.5));
      transition: filter 120ms ease;
    }
    .piece:active{ cursor:grabbing; }

    .piece.active{
      filter:
        drop-shadow(0 0 18px rgba(140,160,255,.55))
        drop-shadow(0 12px 22px rgba(0,0,0,.55));
    }

    /* cele (debug). Jak nie chcesz, ustaw opacity:0 */
    .target{
      position:absolute;
      border:2px dashed rgba(140,160,255,.55);
      border-radius:16px;
      background: rgba(80,100,255,.10);
      pointer-events:none;
      opacity:.20;
    }

    .ok{ outline:3px solid rgba(80,255,160,.9); border-radius:14px; }
    .msg{ margin-top:10px; font-size:14px; opacity:.92; }
    .win{ color:#7dffb3; }
    .warn{ color:#ffd37d; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud">
      <button class="btn" id="reset">Reset</button>
      <div class="hint">
        1) Kliknij lub zÅ‚ap element, Å¼eby go wybraÄ‡ (podÅ›wietli siÄ™).<br>
        2) PrzeciÄ…gnij na planszÄ™. 3) Obracaj kÃ³Å‚kiem myszy, gdy element jest aktywny i nad planszÄ…. ðŸŒ€
      </div>
    </div>

    <div class="board" id="board">
      <!-- TÅO -->
      <img class="bg" src="assets/brain-board.png" alt="plansza" />

      <!-- CELE: ustaw pozycje/wymiary oraz docelowy obrÃ³t w stopniach -->
      <!-- Dopasuj te % pod swojÄ… grafikÄ™ -->
      <div class="target" id="tChip"
           data-target-rot="0"
           style="left:44%; top:18%; width:12%; height:10%;"></div>

      <div class="target" id="tLink"
           data-target-rot="90"
           style="left:47%; top:35%; width:6%; height:55%; border-radius:30px;"></div>

      <!-- ELEMENTY -->
      <img class="piece" id="chip" src="assets/neuro-chip.png" alt="czip"
           data-rot="0"
           style="left:6%; top:70%; width:120px;">

      <img class="piece" id="link" src="assets/blue-linker.png" alt="Å‚Ä…cznik"
           data-rot="0"
           style="left:78%; top:72%; width:70px;">
    </div>

    <div class="msg" id="msg">Status: 0/2 poprawnie.</div>
  </div>

  <script>
    const board = document.getElementById('board');
    const msg = document.getElementById('msg');
    const resetBtn = document.getElementById('reset');

    // Sterowanie
    const ROT_STEP = 7;   // stopni na "zÄ…bek" scrolla
    const ROT_TOL  = 12;  // tolerancja dopasowania kÄ…ta (+/-)

    const state = { placed: { chip:false, link:false } };
    let activePiece = null;

    function rect(el){ return el.getBoundingClientRect(); }

    function normalizeDeg(d){
      d = d % 360;
      if(d < 0) d += 360;
      return d;
    }

    function smallestAngleDiff(a, b){
      const diff = Math.abs(normalizeDeg(a) - normalizeDeg(b));
      return Math.min(diff, 360 - diff);
    }

    function setRotation(el, deg){
      const d = normalizeDeg(deg);
      el.dataset.rot = String(d);
      el.style.transform = `rotate(${d}deg)`;
    }

    function getRotation(el){
      return Number(el.dataset.rot || 0);
    }

    function centerOf(el){
      const r = rect(el);
      return { x: r.left + r.width/2, y: r.top + r.height/2 };
    }

    function isCenterInsideRect(point, r){
      return (point.x >= r.left && point.x <= r.right && point.y >= r.top && point.y <= r.bottom);
    }

    function isPieceCenterInsideBoard(pieceEl){
      const c = centerOf(pieceEl);
      const b = rect(board);
      return isCenterInsideRect(c, b);
    }

    function isCenterInsideTarget(pieceEl, targetEl){
      const c = centerOf(pieceEl);
      const t = rect(targetEl);
      return isCenterInsideRect(c, t);
    }

    function rotationMatches(pieceEl, targetEl){
      const pieceRot = getRotation(pieceEl);
      const targetRot = Number(targetEl.dataset.targetRot || 0);
      return smallestAngleDiff(pieceRot, targetRot) <= ROT_TOL;
    }

    function snapToTarget(pieceEl, targetEl){
      const b = rect(board);
      const t = rect(targetEl);
      const p = rect(pieceEl);

      const targetCenterX = (t.left + t.width/2) - b.left;
      const targetCenterY = (t.top  + t.height/2) - b.top;

      pieceEl.style.left = `${targetCenterX - (p.width/2)}px`;
      pieceEl.style.top  = `${targetCenterY - (p.height/2)}px`;
    }

    function setActive(el){
      if(activePiece === el) return;
      document.querySelectorAll('.piece.active').forEach(p => p.classList.remove('active'));
      activePiece = el;
      if(activePiece) activePiece.classList.add('active');
    }

    function clearActive(){
      document.querySelectorAll('.piece.active').forEach(p => p.classList.remove('active'));
      activePiece = null;
    }

    function updateMsg(){
      const ok = (state.placed.chip?1:0) + (state.placed.link?1:0);
      msg.classList.remove('win','warn');
      msg.textContent = `Status: ${ok}/2 poprawnie.`;
      if(ok === 2){
        msg.textContent = "âœ… UkoÅ„czone! 2/2 poprawnie.";
        msg.classList.add('win');
      }
    }

    function tryPlace(pieceEl, targetEl, key){
      const posOk = isCenterInsideTarget(pieceEl, targetEl);
      const rotOk = rotationMatches(pieceEl, targetEl);

      if(posOk && rotOk){
        snapToTarget(pieceEl, targetEl);
        setRotation(pieceEl, Number(targetEl.dataset.targetRot || 0));

        state.placed[key] = true;
        pieceEl.classList.add('ok');
        pieceEl.style.cursor = 'default';

        if(activePiece === pieceEl) clearActive();
      } else if(posOk && !rotOk){
        msg.textContent = `Prawie! Pozycja OK, ale obrÃ³t nie pasuje (cel: ${targetEl.dataset.targetRot}Â°).`;
        msg.classList.add('warn');
      }

      updateMsg();
    }

    function makeDraggable(pieceEl, targetEl, key){
      let dragging = false;
      let offsetX = 0, offsetY = 0;

      const onDown = (e) => {
        if(state.placed[key]) return;
        dragging = true;

        // wybÃ³r do akcji
        setActive(pieceEl);

        const p = rect(pieceEl);
        offsetX = e.clientX - p.left;
        offsetY = e.clientY - p.top;

        pieceEl.setPointerCapture?.(e.pointerId);
        e.preventDefault();
      };

      const onMove = (e) => {
        if(!dragging || state.placed[key]) return;

        const b = rect(board);
        pieceEl.style.left = `${(e.clientX - b.left - offsetX)}px`;
        pieceEl.style.top  = `${(e.clientY - b.top  - offsetY)}px`;
      };

      const onUp = () => {
        if(!dragging) return;
        dragging = false;
        tryPlace(pieceEl, targetEl, key);
      };

      pieceEl.addEventListener('pointerdown', onDown);
      window.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup', onUp);

      // klik bez przeciÄ…gania teÅ¼ wybiera
      pieceEl.addEventListener('click', () => {
        if(state.placed[key]) return;
        setActive(pieceEl);
      });
    }

    // ObrÃ³t scrollem: tylko gdy element jest aktywny + jego Å›rodek jest nad planszÄ…
    board.addEventListener('wheel', (e) => {
      if(!activePiece) return;                  // nic nie wybrane
      if(!isPieceCenterInsideBoard(activePiece)) return; // aktywny nie jest "nad mÃ³zgiem"

      const id = activePiece.id;
      if(state.placed[id]) return;

      // dopiero teraz przejmujemy kÃ³Å‚ko
      e.preventDefault();

      const dir = Math.sign(e.deltaY); // +1 dÃ³Å‚, -1 gÃ³ra
      setRotation(activePiece, getRotation(activePiece) + dir * ROT_STEP);

      // auto-check po obrocie (fajne, bo "klik" moÅ¼e wskoczyÄ‡ po idealnym kÄ…cie)
      if(id === 'chip') tryPlace(activePiece, document.getElementById('tChip'), 'chip');
      if(id === 'link') tryPlace(activePiece, document.getElementById('tLink'), 'link');
    }, { passive: false });

    // klik w puste tÅ‚o planszy usuwa aktywnoÅ›Ä‡ (opcjonalnie, ale czytelne)
    board.addEventListener('pointerdown', (e) => {
      if(e.target.closest?.('.piece')) return;
      clearActive();
    });

    // init rotacji
    document.querySelectorAll('.piece').forEach(p => setRotation(p, getRotation(p)));

    // podpinamy elementy
    makeDraggable(document.getElementById('chip'), document.getElementById('tChip'), 'chip');
    makeDraggable(document.getElementById('link'), document.getElementById('tLink'), 'link');

    // reset
    resetBtn.addEventListener('click', () => {
      const chip = document.getElementById('chip');
      const link = document.getElementById('link');

      chip.style.left = '6%';  chip.style.top = '70%';
      link.style.left = '78%'; link.style.top = '72%';

      setRotation(chip, 0);
      setRotation(link, 0);

      chip.classList.remove('ok'); link.classList.remove('ok');
      chip.style.cursor = ''; link.style.cursor = '';

      state.placed.chip = false;
      state.placed.link = false;

      clearActive();
      msg.classList.remove('win','warn');
      msg.textContent = 'Status: 0/2 poprawnie.';
      updateMsg();
    });

    updateMsg();
  </script>
</body>
</html>

